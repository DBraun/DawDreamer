name: all
on: [push]
jobs:

  build-ubuntu:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: [3.9]

    steps:
    - uses: actions/checkout@v2
      with:
        submodules: true

    - name: Setup Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install Ubuntu dependencies
      # todo: need to run this? update-ca-certificates \
      run: |
        sudo apt-get update -yq \
        && sudo apt-get install -yq --no-install-recommends \
        ca-certificates \
        build-essential \
        clang \
        pkg-config \
        libboost-all-dev \
        libboost-python-dev \
        libfreetype6-dev \
        libx11-dev \
        libxinerama-dev \
        libxrandr-dev \
        libxcursor-dev \
        mesa-common-dev \
        libasound2-dev \
        freeglut3-dev \
        libxcomposite-dev \
        libcurl4-gnutls-dev \
        git \
        cmake \
        python3 \
        python3.9-dev \
        faust \
        libsamplerate0 \
        llvm-11 \
        llvm-11-dev \
        && sudo apt-get clean -y

    - name: Make symantic links
      run: |
        sudo ln -s /usr/bin/llvm-config-11 /usr/bin/llvm-config
        sudo ln -s /usr/lib/x86_64-linux-gnu/libsamplerate.so.0 /usr/local/lib/libsamplerate.so

    - name: Build DawDreamer
      run: |
        CPLUS_INCLUDE_PATH=/usr/include/python3.9/
        cd Builds/LinuxMakefile
        sudo ldconfig
        make CONFIG=Release
        cp build/libdawdreamer.so ../../tests/dawdreamer.so

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install setuptools wheel pytest numpy librosa scipy

    # - name: Test with pytest  # don't do this because we're not on the main branch yet
    #   run: |
    #     cd tests
    #     pytest .

    - name: Checkout faustlibraries
      uses: actions/checkout@v2
      with:
        repository: grame-cncm/faustlibraries
        path: faustlibraries

    - name: copy faust libraries
      # necessary for setup.py to work.
      run: |
        cp -v -r faustlibraries dawdreamer
        rm -rf dawdreamer/faustlibraries/.git

    - name: Install cibuildwheel
      run: python -m pip install cibuildwheel>=2.1.1

    # # I think the audit is failing because the build links against local LLVM-related things.
    # - name: Build wheels
    #   run: |
    #     python -m cibuildwheel --output-dir wheelhouse --platform linux
    #   env:
    #     CIBW_BUILD_VERBOSITY: 1
    #     CIBW_REPAIR_WHEEL_COMMAND_LINUX: pip install auditwheel-symbols && (auditwheel repair -w {dest_dir} {wheel} || auditwheel-symbols --manylinux 2010 {wheel})
    #     CIBW_TEST_REQUIRES: -r test-requirements.txt
    #     CIBW_TEST_COMMAND: "cd {project}/tests && pytest ."
    #     CIBW_ARCHS: auto64
    #     CIBW_SKIP: "*pp* *p36-* *p37-* *p38-* *p310-*"

    # - uses: actions/upload-artifact@v2
    #   with:
    #     name: my-wheel-artifact
    #     path: ./wheelhouse/*.whl

  build-ubuntu-docker:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: [3.9]

    steps:
    - uses: actions/checkout@v2
      with:
        submodules: true

    - name: Setup Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install setuptools wheel pytest numpy librosa scipy

    - name: Build Docker image
      run: docker build -t dawdreamer .

    # todo: enable this, but note that the Dockerfile pulls the main branch!
    # - uses: addnab/docker-run-action@v3
    #   with:
    #     image: dawdreamer
    #     run: |
    #       echo "Running tests"
    #       cd /DawDreamer/tests
    #       pytest .

  build-windows:
    runs-on: windows-latest

    strategy:
      matrix:
        python-version: [3.8.10]

    steps:
    - uses: actions/checkout@v2
      with:
        submodules: true

    - name: Checkout faustlibraries
      uses: actions/checkout@v2
      with:
        repository: grame-cncm/faustlibraries
        path: faustlibraries

    - name: copy faust libraries
      # necessary for setup.py to work.
      run: |
        cp -v -r faustlibraries dawdreamer
        mkdir C:/hostedtoolcache/windows/Python/${{ matrix.python-version }}/share/faust
        cp faustlibraries/*.lib C:/hostedtoolcache/windows/Python/${{ matrix.python-version }}/share/faust

    - name: Setup Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install setuptools wheel pytest numpy librosa scipy

    - name: Add msbuild to PATH
      uses: microsoft/setup-msbuild@v1.0.3

    - name: Build Windows (Release)
      env:
        PYTHONPATH: C:/hostedtoolcache/windows/Python/${{ matrix.python-version }}/x64
      run: |
        msbuild Builds/VisualStudio2019/DawDreamer.sln /property:Configuration=Release

    - name: Test with pytest
      run: |
        cd tests
        pytest .

    - name: Install cibuildwheel
      run: python -m pip install cibuildwheel>=2.1.1

    - name: Build wheels
      run: |
        python -m cibuildwheel --output-dir wheelhouse
      env:
        CIBW_BUILD_VERBOSITY: 1
        CIBW_TEST_REQUIRES: -r test-requirements.txt
        CIBW_TEST_COMMAND: "cd {project}\\tests && pytest ."
        CIBW_ARCHS: auto64
        CIBW_SKIP: "*pp*"

    - uses: actions/upload-artifact@v2
      with:
        name: my-wheel-artifact
        path: ./wheelhouse/*.whl

  build-macos-11:
    runs-on: macos-11

    strategy:
      matrix:
        python-version: [3.8.10]

    steps:
    - uses: actions/checkout@v2
      with:
        submodules: true

    - name: Setup Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install setuptools wheel pytest numpy librosa scipy

    - name: Checkout faustlibraries
      uses: actions/checkout@v2
      with:
        repository: grame-cncm/faustlibraries
        path: faustlibraries

    - name: copy faust libraries
      run: |
        mkdir -p /Users/runner/hostedtoolcache/Python/${{ matrix.python-version }}/share/faust
        cp /Users/runner/work/DawDreamer/DawDreamer/faustlibraries/*.lib /Users/runner/hostedtoolcache/Python/${{ matrix.python-version }}/share/faust/
        mkdir -p /Users/runner/hostedtoolcache/Python/${{ matrix.python-version }}/x64/share/faust
        cp /Users/runner/work/DawDreamer/DawDreamer/faustlibraries/*.lib /Users/runner/hostedtoolcache/Python/${{ matrix.python-version }}/x64/share/faust/
        mkdir -p /usr/local/share/faust/
        cp /Users/runner/work/DawDreamer/DawDreamer/faustlibraries/*.lib /usr/local/share/faust/

    - name: Build MacOS (Release)
      run: |
        xcodebuild -configuration Release -project Builds/MacOSX/DawDreamer.xcodeproj/
        mv Builds/MacOSX/build/Release/dawdreamer.so.dylib Builds/MacOSX/build/Release/dawdreamer.so
        otool -L Builds/MacOSX/build/Release/dawdreamer.so
        install_name_tool -change @rpath/libfaust.2.dylib @loader_path/libfaust.2.dylib Builds/MacOSX/build/Release/dawdreamer.so
        otool -L Builds/MacOSX/build/Release/dawdreamer.so
        cp Builds/MacOSX/build/Release/dawdreamer.so /Users/runner/hostedtoolcache/Python/${{ matrix.python-version }}/x64/bin/dawdreamer.so
        cp thirdparty/libfaust/darwin-x64/Release/libfaust.a /Users/runner/hostedtoolcache/Python/${{ matrix.python-version }}/x64/bin/libfaust.2.dylib

    - name: Test with pytest
      run: |
        cd tests
        pytest .

    - name: copy faust libraries
      # necessary for setup.py to work.
      run: |
        cp -v -r faustlibraries dawdreamer
        rm -rf dawdreamer/faustlibraries/.git

    - name: Install cibuildwheel
      run: python -m pip install cibuildwheel>=2.1.1

    - name: Build wheels
      run: |
        python -m cibuildwheel --output-dir wheelhouse
      env:
        CIBW_BUILD_VERBOSITY: 1
        CIBW_TEST_REQUIRES: -r test-requirements.txt
        CIBW_TEST_COMMAND: "cd {project}/tests && pytest ."
        CIBW_SKIP: pp*-macosx* cp36-macosx* cp37-macosx*
        MACOSX_DEPLOYMENT_TARGET: 10.15
        CIBW_ARCHS: auto64
        CIBW_ARCHS_MACOS: x86_64 universal2 # Support Apple Silicon

    - uses: actions/upload-artifact@v2
      with:
        name: my-wheel-artifact
        path: ./wheelhouse/*.whl

  upload-pypi:
    # if: always()
    needs: [build-windows, build-ubuntu, build-macos-11]
    runs-on: ubuntu-latest
    name: "Upload wheels to PyPI"
    # if: github.event_name == 'release' && github.event.action == 'published'
    steps:
      - uses: actions/download-artifact@v2
        with:
          name: my-wheel-artifact
          path: dist

      - uses: pypa/gh-action-pypi-publish@release/v1
        with:
          user: __token__
          password: ${{ secrets.TEST_PYPI_API_TOKEN }}
          repository_url: https://test.pypi.org/legacy/